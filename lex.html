<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lexical Decision Task</title>
  </head>
  <body>
    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        font-family: Arial, sans-serif;
        background-color: #f0f0f0;
      }

      h1 {
        margin-bottom: 20px;
        color: #333;
      }

      #gameCanvas {
        width: 600px;
        height: 400px;
        border: 2px solid #333;
        background-color: white;
        margin: 20px 0;
      }

      #startButton {
        padding: 15px 30px;
        font-size: 18px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      #startButton:hover {
        background-color: #45a049;
      }

      #startButton:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
    </style>

    <h1>Lexical Decision Task</h1>
    <canvas id="gameCanvas" width="600" height="400"></canvas>
    <button id="startButton">Start Game</button>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const startButton = document.getElementById("startButton");

      // Game state constants
      const GameState = {
        WAITING: "waiting",
        INSTRUCTIONS_1: "instructions_1",
        INSTRUCTIONS_2: "instructions_2",
        PLAYING: "playing",
        FINISHED: "finished",
      };

      // Word pairs for the lexical decision task
      // Format: [word1, word2, condition, correctAnswer (1=both real/A, 2=nonword/L), trialType]
      const WORD_PAIRS = [
        {
          word1: "DOCTOR",
          word2: "NURSE",
          condition: "related",
          correctAnswer: 1,
          trialType: 1,
        },
        {
          word1: "DOCTOR",
          word2: "FLIPO",
          condition: "nonword",
          correctAnswer: 2,
          trialType: 2,
        },
        {
          word1: "TREE",
          word2: "DOCTOR",
          condition: "unrelated",
          correctAnswer: 1,
          trialType: 1,
        },
        {
          word1: "DOCTOR",
          word2: "NURSE",
          condition: "unrelated",
          correctAnswer: 1,
          trialType: 1,
        },
        {
          word1: "DOCTOR",
          word2: "FLIPO",
          condition: "nonword",
          correctAnswer: 2,
          trialType: 2,
        },
        {
          word1: "BUTTER",
          word2: "BREAD",
          condition: "related",
          correctAnswer: 1,
          trialType: 1,
        },
        {
          word1: "BREAD",
          word2: "DOCTOR",
          condition: "unrelated",
          correctAnswer: 1,
          trialType: 1,
        },
        {
          word1: "SOAM",
          word2: "GLOVE",
          condition: "nonword",
          correctAnswer: 2,
          trialType: 2,
        },
        {
          word1: "NART",
          word2: "TRIEF",
          condition: "nonword",
          correctAnswer: 2,
          trialType: 2,
        },
        {
          word1: "PLAME",
          word2: "WINE",
          condition: "nonword",
          correctAnswer: 2,
          trialType: 2,
        },
      ];

      // Timing constants (in milliseconds)
      const TIMING = {
        PLUS_SIGN: 500,
        CLEAR_SCREEN: 500,
        RESPONSE_WINDOW: 2000,
        FEEDBACK_DISPLAY: 500,
      };

      const TOTAL_TRIALS = WORD_PAIRS.length;

      // Game variables
      let currentState = GameState.WAITING;
      let currentTrial = 0;
      let currentPair = null;
      let awaitingResponse = false;
      let responseTimeout = null;
      let correctCount = 0;

      // Global metrics variables (accessible from window)
      window.task_e = false; // Task engaged flag
      window.task_te = 0; // Time engaged (milliseconds)
      window.task_ct = 0; // Correct trials count
      let gameStartTime = 0;

      // Event listeners
      startButton.addEventListener("click", handleStartButton);
      document.addEventListener("keydown", handleKeyPress);

      /**
       * Handle start button click
       */
      function handleStartButton() {
        startButton.disabled = true;
        startButton.textContent = "Game in Progress...";
        showInstructions1();
      }

      /**
       * Handle keyboard input based on current game state
       */
      function handleKeyPress(event) {
        if (event.code === "Space") {
          event.preventDefault();

          switch (currentState) {
            case GameState.INSTRUCTIONS_1:
              startGameplay();
              break;
          }
        }

        // Handle game responses (A and L keys)
        if (currentState === GameState.PLAYING && awaitingResponse) {
          const key = event.key.toLowerCase();
          if (key === "a" || key === "l") {
            event.preventDefault();
            handleResponse(key);
          }
        }
      }

      /**
       * Display first set of instructions
       */
      function showInstructions1() {
        currentState = GameState.INSTRUCTIONS_1;
        clearCanvas();

        ctx.font = "28px Arial";
        ctx.fillStyle = "black";
        ctx.textAlign = "center";
        ctx.textBaseline = "alphabetic";

        ctx.fillText("Lexical Decision Task", canvas.width / 2, 60);

        ctx.font = "22px Arial";
        ctx.fillText("Instructions:", canvas.width / 2, 100);

        ctx.font = "20px Arial";
        ctx.fillText(
          "In this task, you will see two words at a time.",
          canvas.width / 2,
          140
        );

        ctx.fillText(
          "If BOTH words are REAL ENGLISH words,",
          canvas.width / 2,
          180
        );
        ctx.fillText('press the "A" key.', canvas.width / 2, 210);

        ctx.fillText(
          "If ONE or BOTH words are nonsense words",
          canvas.width / 2,
          250
        );
        ctx.fillText(
          '(for example "FLUMMOL"), press the "L" key.',
          canvas.width / 2,
          280
        );

        ctx.font = "22px Arial";
        ctx.fillStyle = "#333";
        ctx.fillText("Respond within 2 seconds.", canvas.width / 2, 320);

        ctx.font = "18px Arial";
        ctx.fillStyle = "#666";
        ctx.fillText(
          "Press SPACEBAR to start the task",
          canvas.width / 2,
          canvas.height - 50
        );
      }

      /**
       * Start the actual gameplay
       */
      function startGameplay() {
        currentState = GameState.PLAYING;
        currentTrial = 0;
        correctCount = 0;

        // Set engagement flag and record start time
        window.task_e = true;
        gameStartTime = Date.now();

        runTrial();
      }

      /**
       * Run a single trial of the lexical decision task
       */
      function runTrial() {
        if (currentTrial >= TOTAL_TRIALS) {
          endGame();
          return;
        }

        currentPair = WORD_PAIRS[currentTrial];
        currentTrial++;

        // Step 1: Show plus sign for 500ms
        showPlusSign();
        setTimeout(() => {
          // Step 2: Clear screen for 500ms
          clearCanvas();
          setTimeout(() => {
            // Step 3: Show words and wait for response
            showWordPair();
          }, TIMING.CLEAR_SCREEN);
        }, TIMING.PLUS_SIGN);
      }

      /**
       * Display the fixation plus sign
       */
      function showPlusSign() {
        clearCanvas();
        ctx.font = "60px Arial";
        ctx.fillStyle = "black";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("+", canvas.width / 2, canvas.height / 2);
      }

      /**
       * Display the word pair and wait for response
       */
      function showWordPair() {
        clearCanvas();
        ctx.font = "bold 48px Arial";
        ctx.fillStyle = "black";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        // Display first word above center
        ctx.fillText(
          currentPair.word1,
          canvas.width / 2,
          canvas.height / 2 - 40
        );

        // Display second word below center
        ctx.fillText(
          currentPair.word2,
          canvas.width / 2,
          canvas.height / 2 + 40
        );

        // Start waiting for response
        awaitingResponse = true;

        // Set timeout for response window
        responseTimeout = setTimeout(() => {
          if (awaitingResponse) {
            handleTimeout();
          }
        }, TIMING.RESPONSE_WINDOW);
      }

      /**
       * Handle user response
       */
      function handleResponse(key) {
        if (!awaitingResponse) return;

        awaitingResponse = false;
        clearTimeout(responseTimeout);

        // Determine if response is correct
        // 'a' key = answer 1 (both real words)
        // 'l' key = answer 2 (contains nonword)
        const userAnswer = key === "a" ? 1 : 2;
        const isCorrect = userAnswer === currentPair.correctAnswer;

        if (isCorrect) {
          correctCount++;
          window.task_ct = correctCount;
          showFeedback("CORRECT", "green");
        } else {
          showFeedback("INCORRECT", "red");
        }
      }

      /**
       * Handle response timeout
       */
      function handleTimeout() {
        awaitingResponse = false;
        showFeedback("INCORRECT", "red");
      }

      /**
       * Display feedback message
       */
      function showFeedback(message, color) {
        clearCanvas();
        ctx.font = "bold 48px Arial";
        ctx.fillStyle = color;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(message, canvas.width / 2, canvas.height / 2);

        // Continue to next trial after delay
        setTimeout(() => {
          runTrial();
        }, TIMING.FEEDBACK_DISPLAY);
      }

      /**
       * End the game and show results
       */
      function endGame() {
        currentState = GameState.FINISHED;

        // Calculate time engaged and update global metrics
        const gameEndTime = Date.now();
        window.task_te = gameEndTime - gameStartTime;
        window.task_ct = correctCount;

        // Log metrics to console
        console.log("=== Game Metrics ===");
        console.log("task_e (engaged):", window.task_e);
        console.log("task_te (time engaged in ms):", window.task_te);
        console.log("task_ct (correct trials):", window.task_ct);
        console.log("===================");

        clearCanvas();

        const accuracy = ((correctCount / TOTAL_TRIALS) * 100).toFixed(1);

        ctx.font = "36px Arial";
        ctx.fillStyle = "black";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(
          "Task Complete!",
          canvas.width / 2,
          canvas.height / 2 - 60
        );

        ctx.font = "28px Arial";
        ctx.fillText(
          `Score: ${correctCount} / ${TOTAL_TRIALS}`,
          canvas.width / 2,
          canvas.height / 2
        );
        ctx.fillText(
          `Accuracy: ${accuracy}%`,
          canvas.width / 2,
          canvas.height / 2 + 40
        );

        // Re-enable start button
        startButton.disabled = false;
        startButton.textContent = "Start Game";
      }

      /**
       * Clear the canvas
       */
      function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      /**
       * Initialize the game - show initial message
       */
      function init() {
        ctx.font = "24px Arial";
        ctx.fillStyle = "#666";
        ctx.textAlign = "center";
        ctx.textBaseline = "alphabetic";
        ctx.fillText(
          'Click "Start Game" to begin',
          canvas.width / 2,
          canvas.height / 2
        );
      }

      // Initialize on load
      init();
    </script>
  </body>
</html>
